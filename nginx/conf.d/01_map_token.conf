map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Extract Bearer token from Authorization header or "token" cookie or "token" query param
# Priority: Authorization > Cookie > Query
# (Query fallback is useful for CLI/scripts)
map $http_authorization $auth_bearer_hdr {
    default "";
    "~*^Bearer\s+(.+)$" $1;
}

map $cookie_token $auth_bearer_cookie {
    default "";
}

map $arg_token $auth_bearer_arg {
    default "";
}

# Choose the token to forward to auth backend
map "$auth_bearer_hdr$auth_bearer_cookie$auth_bearer_arg" $device_token {
    default "";
    "~*" $auth_bearer_hdr;
}

# If no Authorization header, but cookie exists, use cookie
map $device_token $device_token_final {
    default $device_token;
    "" $auth_bearer_cookie;
}

# If still empty, fall back to query arg
map $device_token_final $device_token_any {
    default $device_token_final;
    "" $auth_bearer_arg;
}
